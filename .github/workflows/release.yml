name: GitHub Release

on:
  schedule:
    # Runs at 23:15 Asia/Shanghai (UTC+8) => 15:15 UTC
    - cron: '15 15 * * *'
  push:
    branches: [ master ]

jobs:
  # 1. Build artifacts in parallel
  build:
    strategy:
      matrix:
        cores: [ 2, 4, 8, 16, 32, 64, 128 ]
    runs-on: ubuntu-latest
    container: ghcr.io/openxiangshan/xs-env:ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup dependency
        run: |
          # This is required by ocaml/setup-ocaml and opam
          apt update
          apt install -y unzip bzip2

      - uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 4
          opam-disable-sandboxing: true

      - name: Setup herdtools7
        run: |
          opam install herdtools7

      - name: Build
        run: |
          opam exec -- make hw-tests CORES=${{ matrix.cores }} GCC=riscv64-linux-gnu-gcc -j2

      - name: Tarball
        run: |
          mv hw-tests litmus-tests-riscv-${{ matrix.cores }}C
          tar -czf litmus-tests-riscv-${{ matrix.cores }}C.tar.gz litmus-tests-riscv-${{ matrix.cores }}C

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: litmus-tests-riscv-${{ matrix.cores }}C.tar.gz
          path: litmus-tests-riscv-${{ matrix.cores }}C.tar.gz

  # 2. Create release if there are new commits since last tag
  release:
    if: github.event_name == 'schedule'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Check for commits since last release
        id: check_changes
        shell: bash
        run: |
          LATEST_TAG="$(git tag -l "litmus-tests-*" --sort=-v:refname | head -n1 || true)"
          if [ -z "$LATEST_TAG" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            COUNT=$(git rev-list "${LATEST_TAG}..HEAD" --count)
            if [ "$COUNT" -gt 0 ]; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Set release date (UTC+8)
        run: |
          DATE=$(TZ=Asia/Shanghai date +%Y%m%d)
          echo "RELEASE_TAG=litmus-tests-${DATE}" >> "$GITHUB_ENV"

      - name: Create git tag
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ env.RELEASE_TAG }}" -m "Release ${{ env.RELEASE_TAG }}"
          git push origin "${{ env.RELEASE_TAG }}"

      - name: Create release
        if: steps.check_changes.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TAG }}
          make_latest: true
          fail_on_unmatched_files: true
          preserve_order: true
          files: |
            litmus-tests-riscv-*.tar.gz
